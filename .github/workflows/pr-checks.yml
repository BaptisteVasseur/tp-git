name: âœ… VÃ©rifications Pull Request

on:
  pull_request:
    branches: [ main ]

jobs:
  check-pr:
    runs-on: ubuntu-latest
    name: VÃ©rifier la Pull Request
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v3
      
    - name: ğŸ” VÃ©rification de la structure des commits
      run: |
        echo "ğŸ” VÃ©rification des messages de commits..."
        git log --oneline origin/main..HEAD | while read line; do
          if [[ $line =~ ^[a-f0-9]+\ (feat|fix|docs|style|refactor|test|chore)(\(.+\))?:\ .+ ]] || [[ $line =~ ^[a-f0-9]+\ (âœ¨|ğŸ›|ğŸ“|ğŸ’„|â™»ï¸|âœ…|ğŸ”§) ]]; then
            echo "âœ… Commit valide: $line"
          else
            echo "âŒ Commit non conforme: $line"
            echo "ğŸ’¡ Utilisez le format: 'type: description' ou les gitmoji"
            exit 1
          fi
        done
        
    - name: ğŸ“ VÃ©rification de l'arborescence
      run: |
        echo "ğŸ“ VÃ©rification de la structure des fichiers..."
        
        # VÃ©rifier que les nouveaux fichiers HTML sont dans le bon dossier
        if git diff --name-only origin/main..HEAD | grep -E "\.html$" | grep -v "^pages/" | grep -v "^index.html$"; then
          echo "âŒ Les fichiers HTML doivent Ãªtre dans le dossier 'pages/' (sauf index.html)"
          exit 1
        fi
        
        # VÃ©rifier que les CSS sont dans le bon dossier  
        if git diff --name-only origin/main..HEAD | grep -E "\.css$" | grep -v "^css/"; then
          echo "âŒ Les fichiers CSS doivent Ãªtre dans le dossier 'css/'"
          exit 1
        fi
        
        echo "âœ… Structure des fichiers conforme"
        
    - name: ğŸ”— VÃ©rification des liens
      run: |
        echo "ğŸ”— VÃ©rification des liens internes..."
        
        # Simple vÃ©rification que les liens relatifs existent
        for file in $(find . -name "*.html"); do
          echo "VÃ©rification de $file..."
          
          # Extraire les liens href et src relatifs
          grep -oE 'href="[^"]*"' "$file" | sed 's/href="//g; s/"//g' | while read link; do
            if [[ $link =~ ^[^http] ]] && [[ $link != "#"* ]]; then
              target_file=$(dirname "$file")/"$link"
              if [ ! -f "$target_file" ]; then
                echo "âŒ Lien cassÃ© dans $file: $link -> $target_file"
                exit 1
              fi
            fi
          done
        done
        
        echo "âœ… Liens vÃ©rifiÃ©s"
        
    - name: ğŸ‰ Validation rÃ©ussie
      run: |
        echo "ğŸ‰ Toutes les vÃ©rifications sont passÃ©es !"
        echo "ğŸš€ La Pull Request peut Ãªtre mergÃ©e !"
